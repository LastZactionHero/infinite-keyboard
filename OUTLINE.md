**Project: Infinite Keyboard - Circuit Overview**

**Last Updated:** May 10, 2025 (Based on latest schematic review)

**1. Project Goal & Core Functionality:**
The "Infinite Keyboard" is a portable musical scratchpad. Its primary function is to continuously capture every note played on its integrated keyboard as MIDI data, saving this data directly to an SD card. This allows musicians to freely improvise and play ideas as they occur, with the assurance that the performance is recorded and can be revisited or exported later. The system includes headphone output for monitoring and USB connectivity for power and potential future MIDI output/data transfer.

**2. Key Components & Subsystems:**

*   **Microcontroller (MCU): ESP32-S3-WROOM-1-N8 (IC1)**
    *   Core of the system, responsible for:
        *   Scanning the keyboard matrix.
        *   Interpreting key presses into MIDI note data.
        *   Managing the SD card interface (SPI or SDIO mode) for writing MIDI files.
        *   Controlling the PCM5102A DAC via I²S for audio generation (likely for metronome/monitoring).
        *   Controlling the TPA6130A2 headphone amplifier via I²C (volume, mute, etc.).
        *   Driving status LEDs.
        *   Handling USB communication (power, potential MIDI I/O).
        *   Managing boot mode and user interface switches.
*   **Digital-to-Analog Converter (DAC): PCM5100APWR (IC3)**
    *   Receives I²S audio data from the ESP32.
    *   Converts digital audio to analog signals for headphone output.
    *   Operates in 3-wire I²S mode (using its internal PLL, SCK pin tied to GND).
    *   Configuration pins (FLT, FMT, DEMP) are tied to GND for normal latency FIR filter, I²S format, and de-emphasis off.
    *   XSMT (soft mute) pin is connected to the TPA6130A2 /SD (shutdown) pin, allowing coordinated mute/shutdown.
*   **Headphone Amplifier: TPA6130A2RTJR (IC4)**
    *   Amplifies the analog audio output from the PCM5102A.
    *   Drives the stereo headphone jack (J3).
    *   Features DirectPath™ technology for ground-referenced outputs (eliminates DC-blocking capacitors on output).
    *   Controlled via I²C by the ESP32.
    *   Powered by +5V.
*   **Linear Voltage Regulator (LDO): AP2112K-3.3TRG1 (IC5)**
    *   Takes +5V input (from USB VBUS).
    *   Provides a regulated +3.3V output rail for the ESP32, SD card, PCM5102A, and other 3.3V logic.
    *   Capacity: 600mA.
    *   Enable pin needs to be pulled high for operation.
*   **Keyboard Matrix:**
    *   24 keyswitches (SW1-SW24).
    *   Diode matrix (D1-D24, 1N4148WS) for N-key rollover and ghosting prevention.
    *   Scanned by ESP32 GPIOs (ROW1-6, COL1-4).
*   **Storage: Micro SD Card Slot (J2 - MSD-1-A)**
    *   Used for storing captured MIDI data.
    *   Interfaced with the ESP32.
    *   **Current plan is SPI mode (CLK, CMD/MOSI, DAT0/MISO, DAT3/CS).**
    *   Includes series termination resistors on actively driven lines and pull-up resistors on necessary signal lines.
    *   Mechanical card detect switch (CD1) connected to ESP32-IO35.
*   **User Interface:**
    *   Control Switches: BOOT1 (GPIO0), RESET1 (EN), MODE_A2 (GPIO45), MODE_B2 (GPIO46/GPIO3 - *pin assignment needs final confirmation*).
    *   Status LEDs: POWER1, RUNNING1, MODE_A1, MODE_B1. Anodes to +5V via 330Ω resistors, cathodes to ESP32 GPIOs.
*   **Connectors:**
    *   USB Type-C (J1 - UJ20-C-H-G-SMT-5-P16-TR): For power input (+5V) and potential USB data/MIDI. CC1/CC2 pins have 5.1kΩ pull-downs for UFP (device) mode.
    *   3.5mm Audio Jack (J3 - SJ-43617-SMT-TR): Stereo headphone output with tip, ring1, ring2, sleeve, and three detection switches (connected to ESP32 GPIOs).

**3. Power Distribution:**

*   **+5V Rail:** Derived from USB VBUS. Powers the TPA6130A2 headphone amplifier and is the input to the 3.3V LDO. Decoupled by C16, C19, C27.
*   **+3.3V Rail:** Generated by the AP2112K LDO (IC5) from the +5V rail. Powers the ESP32-S3, PCM5102A, SD card, and pull-up resistors for various logic signals. Extensively decoupled by C1, C3, C4, C5, C6, C7, C8, C9, C24, C25, C26, C28.

**4. Key Signal Paths & Interfaces:**

*   **Keyboard Data:** Switches -> Diode Matrix -> ESP32 GPIOs (Rows/Columns).
*   **SD Card Data (SPI Mode):** ESP32 SPI Pins <-> Series Resistors <-> J2 (SD Card).
    *   CLK, CMD (MOSI), DAT0 (MISO), DAT3 (CS) are the primary lines.
    *   Pull-ups on CMD, DAT0, DAT3, and recommended on unused DAT1, DAT2.
*   **Audio Path:**
    *   ESP32 (I²S: BCK, LRCK, DIN) -> PCM5102A (IC3).
    *   PCM5102A Analog Output (OUTL/R) -> RC Filters (R5/C14, R6/C15) ->
    *   AC Coupling Caps (C20-C23, 0.47µF) -> TPA6130A2 Analog Inputs (LEFTINP/M, RIGHTINP/M).
    *   TPA6130A2 Amplified Output (HPLEFT/HPRIGHT) -> J3 (Audio Jack).
*   **Control Interfaces:**
    *   ESP32 (I²C: SDA, SCL with R8/R9 pull-ups) -> TPA6130A2 (IC4).
    *   ESP32 GPIOs -> PCM5102A (XSMT), TPA6130A2 (/SD).
    *   ESP32 GPIOs -> LEDs.
    *   ESP32 GPIOs <- Switches (BOOT, RESET, MODE, Audio Jack Detect).
*   **USB Interface:** J1 (USB-C D+/D-) -> ESP32 (IO19/IO20).

**5. Important Design Considerations & Potential Review Points (for PCB stage):**

*   **LDO (IC5) Enable Pin:** The EN pin of the AP2112K LDO must be pulled high for the LDO to be active. This connection needs to be explicitly made.
*   **LDO (IC5) Pinout:** Ensure PCB footprint for IC5 matches the AP2112K pinout, as it differs from the previously considered MIC5504.
*   **SD Card Interface (SPI Mode):**
    *   Ensure DAT3 (CS) is correctly wired to an ESP32 GPIO, has a series termination resistor, and a pull-up resistor.
    *   Recommended to add pull-up resistors to +3.3V for the unused SD card lines DAT1 and DAT2 at the connector (J2) to prevent them from floating.
*   **Audio Jack Switch Pull-ups:** ESP32 GPIOs connected to the audio jack detection switches (J3 pins 10, 11, 12) should have external pull-up resistors or reliably enabled internal pull-ups to prevent floating inputs.
*   **ESP32 Strapping Pin GPIO3 (MODE_B1 LED / Switch):** If GPIO3 is indeed used for this dual purpose, ensure its boot-time state is reliably defined (e.g., via an external pull-up/down) considering its "floating" default state and connection to a switch.
*   **USB D+/D- Series Resistors:** Currently not present. Evaluate if needed based on trace length and desired USB robustness. (For FS, short traces might be okay).
*   **Decoupling Capacitor Placement:** Critical for all ICs. Must be as close as possible to power and ground pins.
*   **Grounding:** A solid ground plane is highly recommended. Pay attention to analog vs. digital ground separation/connection points, especially around the PCM5102A and TPA6130A2.
*   **Signal Routing:** Keep analog audio paths clean and isolated from digital noise. Route high-speed SD card and USB lines carefully.
*   **Thermal Management:** Provide adequate copper for heat dissipation for the LDO (IC5) and ESP32 (IC1).

**6. Bill of Materials (BOM) Notes:**

*   C24 value was updated to 1uF.
*   Resistors R20-R23 are 22Ω for SD card line termination. Additional resistors might be needed if 4-bit SD mode was chosen (but SPI is now confirmed).
*   Confirm all generic components (LEDs, Switches) have appropriate footprints selected.

This overview should provide a good foundation for evaluating the PCB layout. The critical items revolve around ensuring correct power delivery (LDO enable and pinout), robust SD card interfacing for the chosen SPI mode, and careful handling of sensitive analog signals and high-speed digital lines.